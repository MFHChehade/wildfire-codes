clc;clear all;
yalmip clear;
options = sdpsettings('verbose', 1, 'dualize', 0);
mpc = loadcase('case_RTS_GMLC');

gen = mpc.gen(:,[1;9;10]);
gen_concise = [101 20 8];

for i = 2:length(gen)
    if(ismember(gen(i,1), gen_concise(:,1)) == 1)
        index = find(gen_concise(:,1)== gen(i,1));
        gen_concise(index,2) = gen_concise(index,2) + gen(i,2);
        gen_concise(index,3) = gen_concise(index,3) + gen(i,3);
    else
        gen_concise = [gen_concise; gen(i,:)];
    end
end

generation = sortrows(gen_concise,1);            
        
%% Renumber the buses
index_old = mpc.bus(:,1);
index_new = (1:73)';

for i = 1:length(generation)
    for j = 1:73
        if (generation(i,1) == index_old(j))
            generation(i,1) = j;
        end
    end
end

P_ng_min = generation(:,3);
P_ng_max = generation(:,2);
%P_ng_min = zeros(73,1);

bus = mpc.bus;
for i = 1:73
    for j = 1:73
        if (mpc.bus(i,1) == index_old(j))
            bus(i,1) = j;
        end
    end
end



%% Generation Costs
c = zeros(73,1);
% r = [18.2100468044368;3.41274950957662;18.3541412666414;13.0148256782828;2.85326769498878;6.29146615847392;11.3907488648947;19.1926298732517;19.3328821687863;3.99464855187342;19.4412628534517;19.1861720166160;10.2221373257340;16.2053289088872;3.69584043391709;9.01346436989923;18.3989749785923;16.0519392616315;19.2303561014652;13.4590732839752;1.67852189290960;17.1334568115068;18.7458717073935;13.8959679422977;15.3970624809883;15.1195168943734;8.45231337114920;13.4540799133736;4.25254706841967;14.4148756723726;1.60482408117099;6.26153671425691;1.87725642199193;2.84550384348110;16.6456987382186;14.2017438365405;7.02489012115635;19.0542189279287;1.65447552955527;9.33614283347157;8.24961068476716;15.5448189748310;16.1087981216042;4.55057948653319;10.3055235199764;9.46613781350709;13.2799471921140;14.4779317863034;15.3390469576649;6.24447646297299;13.9143508602198;13.4468620755030;4.08962296869798;3.26095594960916;10.4689169876607;19.2351352118055;7.46732880665653;12.1200872686158;5.25242685033160;15.2740741268074;5.84680719372611;10.6131839816377;14.2824577304770;17.9271617981802;19.2265370789034;11.3970950693123;3.63386441374490;3.83658610562209;5.89265682835099;16.9736278636896;5.83136140045909;16.4714116953075;5.62697440577480];
% b = 20;
% a = 0;
% r = 20*rand(73,1);

r = [18.5852724637446;6.99967531969618;3.93190500862416;5.02167715952062;12.3208935229328;9.46577697805459;7.03319014125994;16.6165725579258;11.7052818230545;10.9944721658228;18.3438732765962;5.71678037640747;15.1440045822144;15.0745818855699;7.60891693950713;11.3564328145044;1.51708579126127;1.07900237333214;10.6159510601795;15.5833446020402;18.6802136845837;2.59812416947460;11.3764732174439;9.38781282116412;0.238041390024828;6.74245288797763;3.24364616386486;15.8856908136781;6.22430084089610;10.5706627101243;3.31297458999562;12.0396388280327;5.25942569080289;13.0815819695356;13.7842900628002;14.9630318564742;9.01083197004996;1.67642755993865;4.57953937433638;18.2667472300334;3.04756037938446;16.5163395497910;10.7668487052011;19.9226943325377;1.56351057506367;8.85356539550893;2.13305540361169;19.2379616171011;0.0926844826813489;15.4982092942300;16.3460644130687;17.3738941072702;1.68871691021821;7.99565298197793;5.19740805701308;16.0013696044862;8.62827654927089;18.2129518885905;3.63694056605705;5.27605833043980;2.91077960769434;2.72137117417328;17.3858441528018;11.5940917473114;10.9972040367266;2.89909596447454;17.0606223544379;12.4411026297013;7.01904761784542;10.2649907973411;8.03616067503883;1.51933383381684;4.79832307107316];


for i = 1:46
    c(generation(i,1)) = r(i);
end

limit = 0.22*[200;220;220;220;220;220;600;220;220;200;220;220;220;220;600;600;600;600;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;200;220;220;220;220;220;600;220;220;200;220;220;220;600;600;600;600;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;200;220;220;220;220;220;600;220;220;200;220;220;220;600;600;600;600;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;625;893];
mpc.branch = [mpc.branch limit];


bran = mpc.branch;
for i = 1:120
    for j = 1:73
        if (bran(i,1) == index_old(j))
            bran(i,1) = j;
        end
        if (bran(i,2) == index_old(j))
            bran(i,2) = j;
        end
    end
end

BBB = bran;

bran([28,35,37,39,67,74,76,78,105,112,114,116],:) = []; % reduce double lines to single line




branch = bran;

B = 1./bran(:,4); % DC approximation: 1/X 
B1 = [];
for i=1:107
    B1(i) = bran(i,4)/((bran(i,4))^2 + (bran(i,3))^2);
end


%% Decision Variables
theta = sdpvar(73,1); % decision variable
P_nk = sdpvar(108,1); % decision variable
P_ng = sdpvar(73,1); % decision variable

z = binvar(108,1); % decision variable

P_nd = bus(:,3); % load

%% objective function
obj = c'*P_ng;


%% constraint 1 (phase angle)
constraints = {};
theta_min = -ones(73,1);
theta_max = ones(73,1);

constraints{end+1} = theta_min <= theta <= theta_max;
constraints{end+1} = theta(13) == 0;

%% constraint 2 (generation)
for i = 1:46
    constraints{end+1} = P_ng_min(i) <= P_ng(generation(i,1)) <= P_ng_max(i);
end


%% constraint 3 (line flow)
P_nk_max = branch(:,14);
constraints{end+1} = (-P_nk_max).*z <= P_nk <= (P_nk_max).*z;

%% constraint 4 (power balance)
A = zeros(73,108); % node power flow net injection matrix
for i=1:73
    for j=1:108
        if(branch(j,1) == i)
            A(i,j) = 1;
        elseif(branch(j,2) == i)
            A(i,j) = -1;
        end
    end
end


constraints{end+1} = A*P_nk == P_ng  - P_nd;


%% constraint 5 (Big M constraints)
M = zeros(108,73);
for i=1:108
    tmp1 = branch(i,1);
    tmp2 = branch(i,2);
    M(i,tmp1) = B(i);
    M(i,tmp2) = -B(i);
end



 for j = 1:107
     constraints{end+1} = M(j,:)*theta*100000 - P_nk(j) + (1-z(j))*1000 >= 0;
     constraints{end+1} = M(j,:)*theta*100000 - P_nk(j) - (1-z(j))*1000 <= 0;
 end


%% constraint 6 (number of switching lines)
constraints{end+1} = ones(1,108)*(ones(108,1) - z) <= 3;


%% solve the problem
optimize([constraints{:}], obj, options);
z = value(z)
P_ng = value(P_ng);

obj_exact = value(obj)



xi = zeros(32,108);
N = 4;
xx = dec2bin(0:2^N-1)' - '0';
xx = xx';









